This directory contains the code related to the test phase of the experiments presented in the publication.

- [1_extract_ligands.py](/computational/reconstruction/1_extract_ligands.py): this script extracts all the ligands available in the train/validation/test partitions of the available dataset selection (automatically handled). The ligands are stored in the "[intermediate](/computational/reconstruction/intermediate)" folder in .ttl format. Within the files, three special tokens replace respectively the URI reserved for the TMC at the complex level (`@TMC@`), the metal centre at the ligand level (`$MC_LL$`) and the centre at the atomic level (`!MC_AL!`). These tokens are used as a quick way of adapting the ligand to the scaffold it has to be attacched to. After replacing the tokens with the appropriate URIs, each ligand can be attached to any TMC represented in tmQM-RDF simpy by merging the two files.
- [2_process_scaffolds.py](/computational/reconstruction/2_process_scaffolds.py): this script creates the scaffolds by removing, at random, one ligand from each test TMC, and then creates all the possible reconstructions generated by attaching all the ligands found in the training partition. Both scaffolds and reconstructions are stored in the "intermediate" folder. Scaffolds are stored using the format `XXYYZZ__lll.ttl`, where `XXYYZZ` is the CSD code of the original TMC and `lll` is the id of the ligand that has been removed. Reconstructions are stored inside folder named `reconi`, where `i` is a natural number. Inside each folder, there are three elements:
    - `lll.gt`: an empty file where `lll` is the id of the ligand that has been removed from the scaffold.
    - `graphs`: a fodler that contains the RDF graphs of all the generated reconstructions. Reconstructions are stored using the format `XXYYZZ__mmm.ttl`, where `mmm` is the id of the ligand that has been attached to the scaffold.
    - `selection.csv`: a list of all the available reconstruction (added for compatibility with other scripts)
- [3_compute_matches.py](/computational/reconstruction/3_compute_matches.py): for each reconstruction, computes the elementary graph features determined during the training phase. It relies on the script [aux/3_compute_matches.R](/computational/reconstruction/aux/3_compute_matches.R). The desired dataset must be specified (`TM_MODE = "lateTM"` or `TM_MODE = "earlyTM"`). For each reconstruction, the features are stored inside the corresponding `reconi` folder, as a `matches.csv` file.
- [4_compute_scores.py](/computational/reconstruction/4_compute_scores.py): the elementary features are aggregated and then used to compute the typicality of each reconstruction using the pgmpy package and the fitted BNs. Available BNs are automatically detected (confirmation will be asked). The computed scores will be stored in the "[results](/computational/reconstruction/results)" folder, as stringified python dictionaries. Inside these dictionaries, each entry corresponds to a scaffold `XXYYZZ__lll` and to each scaffold a new nested dictionary is associated. The nested dictionary is indexed by the reconstructions `XXYYZZ__mmm` and contains, for each reconstruction, the computed score. 
- [5_compute_rankings.py](/computational/reconstruction/5_compute_rankings.py): the computed scores are converted into rankings. In this phase, the filters on the candidate ligands are enacted (`n` = no filter; `hd` = hapticity/denticity order; `c` = charge). The available rankings are automatically detected (confirmation will be asked. *NOTE: unlike other scripts, this script merges all the outputs in a single file, so only the options selected in the current run will be available in the results*). In the "results" folder, for each filter, the rankings are available in the form of a unified dictionary. The dictionary is indexed by the similarity/aggregation configuration and to each configuration a nested dictionary is associated. The nested dictionary is indexed by the CSD codes of the test TMCs, and to each TMCs, its ranking in the corresponding seet of reconstructions is reported.
- [6_plot_results.py](/computational/reconstruction/6_plot_results.py): this script plots, for each configuration and filter, a plot of the top-k accuracy against $k$. It also prints a table (in LaTeX format) listing for each configuration, the top-k accuracy for $k \in \{1, 5, 10\}$. If the module pyperclip is installed, then the table will also be copied to the clipboard.

# Outputs
- Intermediate:
    - Extracted ligands, scaffolds and reconstructions
- Results:
    - Typicality scores, rankings and plots 
